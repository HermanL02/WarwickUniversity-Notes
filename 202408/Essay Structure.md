# Introduction
In today's digital era, instant messaging platforms have become integral to daily communication. To ensure the communication security, many users prefer to explore any secure communication software as their chat preferences. The popular choices are WhatsApp, Facebook Messenger and iMessage, which provides end-to-end encryption features supported by a variety of protocols. 

Meanwhile, in People's Republic of China(PRC), people cannot find a secure way to communicate. The secure apps we mentioned are not accessible due to the government applied internet restrictions. Instead, in the Chinese market, among all the communication applications and platforms, WeChat stands out with over 1 billion daily active users, making it a dominant force in the messaging area.  However, compare to their competitors on the global market, we found none of the Chinese apps provides an End-to-End Encryption(E2EE) feature, and none of them seen security and communication safety as their priority. This reveals a serious fact, which is over a billion users daily conversation is not protected and fully exposed to the company or the government. 

Therefore, we are here to introduce an E2EE solution for WeChat with main focus on Windows and Android platforms. The whole design has a tested workflow. Although it might not be a production level product to last decades, it potentially benefits people who can only access to the mainland chat applications and the people who need to keep contact with mainland friends. The whole idea also incentivize many more similar applications and urge WeChat and the government policies to change. 

For this application, we give it a name, Libre Chat. 
# # Background and Research
## E2EE Measures from a Global Perspective
There are four properties are used to ensure the messaging is secure, which are confidentiality, integrity, authentication and non-repudiation. [TODO PDF Ref1] There are many encryption protocols are designed to fulfil the these properties, such as Signal protocol and the RSA protocol. 

iMessage, WhatsApp and Zoom provides a default E2EE or provides a E2EE option. iMessage uses PQ3 protocol, WhatsApp and Signal uses Signal protocol. Telegram uses MTProto Protocol. Proton Mail uses RSA protocol. [TODO PDF Ref1]

We can generally consider that E2EE is widely used outside internet restricted area. 
## Current WeChat Encryption Measures
According to the official website of WeChat help center, WeChat uses TLS encryption to secure your data as it moves to and from the servers. For the static data, it uses 256 digits AES encryption. However, during this process, the encryption key is controlled by service provider, Tencent, which means it has a potential threat that Tencent has access to your information and conversation. [TODO https://help.wechat.com/cgi-bin/micromsg-bin/oshelpcenter?opcode=2&plat=1&lang=en&id=1208117b2mai1410243yyQFZ&Channel=helpcenter]

## WeChat Scandal
Above, we talked about the potential technical possibility of WeChat technology. In fact, there are already reports regarding the block and filter of messages of WeChat. It also applies the account ban on sensitive politic messages. 
According to Citizen Lab of the University of Toronto, [TODO https://citizenlab.ca/2020/05/wechat-surveillance-explained/] if a message is censored, it will not notify either the sender and the recipient. For example, in this context example, a user tries to send a sensitive word Dharma Wheel, it will be shown as 'sent' on sender's side and will not be shown on recipient side. 
For text, they use keywords to find sensitive words. For picture, they compare the whole picture with the MD5 hash value with the ones they identified as politics sensitive. In recent years, WeChat also apply the filtering with Optical character recognition(OCR). 

In this article here, it also investigates the picture live detection is based on automatical detection and audit. The audit is based on the OCR of the target photo and compare with the sensitive photo's dasta. It creates a hash index to achive the filtering, and the hash index is generated by the MD5 value. It proves that the government would filter the polictical sensitive information, and filters more in a group chat than in the 1 to 1 chat.  [TODO https://citizenlab.ca/2019/07/cant-picture-this-2-an-analysis-of-wechats-realtime-image-filtering-in-chats/]
## Current Solutions
### Substitution Words
For some users, utilizing VPN proxies is not a viable option. Generally, it is not ideal to cite individual cases, but I feel compelled to mention my father. He is unfamiliar with using VPNs but is acutely aware of the restrictions on free speech. He knows that these restrictions can lead to the suspension of crucial social account, WeChat. In response, he continuously avoids using sensitive words, often substituting them with alternative letters. However, with advancements in AI technology and the expansion of keyword databases, even these substituted letters are increasingly subject to censorship. Consequently, certain letters can no longer be used, as they too are being filtered out.
### Virtual Private Network (VPN)
One popular practice is to use a VPN to access software outside the country to obtain end-to-end encryption. But this approach has many drawbacks.

First, the security of communication between users and VPN service providers is not necessarily guaranteed. Currently, the larger VPN providers, such as NordVPN, Express VPN, are blocked by the government, and their connection speeds are slow and very unstable. Some users choose smaller VPN providers, they usually have a smoother experience, but many providers do not have relevant service qualifications, and do not have formal business registration in any country, so the risk may be greater.

Second, VPN services are essentially in violation of relevant Chinese laws and regulations. Chinese laws and regulations stipulate that only enterprises can apply for the use of international communication channels, and individuals generally have limited requirements for application and are unlikely to be approved.

Third, the use of VPN is not convenient. If we are always connected to VPN, some software cannot be used. For example, the access speed of government affairs software, enterprise information query software and all kinds of WeChat mini programs will become very slow.
\
### E2EE Deprecated Solutions for WeChat
In the past, there are some open source solutions attempt to use web version of WeChat to intercept the messages. It avoids the complexity of reverse engineering. However, as WeChat aware of the potential use of WeChat Web version, they are forcing users to switch to WeChat Desktop version. Therefore, the web version's use becomes very limited. 

# User Manual and Demonstration

The whole video demonstration could be found here. [TODO YOUTUBE] 
## Basic Function Page [TODO PHOTO] 

The Basic Function Page provides users with a foundational set of cryptographic operations, allowing them to experiment with essential features. This page includes several key-related functionalities:

1. **Key Operations**: Users can generate, update, copy, and paste cryptographic keys. Additionally, the page supports key import functionality.
2. **Key Storage**: Users can store and manage other users' public keys by importing them into the system.
3. **Instant Encryption/Decryption**: The page enables real-time encryption and decryption operations, utilizing others' public keys in conjunction with the user's private key.

## WeChat Direct Message Page [TODO PHOTO]

The WeChat Direct Message Page outlines the mandatory steps required to integrate and utilize WeChat for secure communications. Users must complete the following steps:

1. **WeChat Setup**: Install WeChat and add the WeChat Anti-Update Plugin.
2. **Hook WeChat**: The page offers a crucial function to hook WeChat, enabling secure interactions. Upon completing these steps, users can proceed to the subsequent subpages.

### WeChat Communication Channel Build Page [TODO PHOTO]

The WeChat Communication Channel Build Page guides users through establishing a secure communication channel within WeChat. The process involves the following steps:

1. **Hook WeChat**: Both users must hook WeChat to prepare for secure communication.
2. **Temporary Encrypted Chat**: 
   - The first user selects "Listen for a Temporary Encrypted Chat" after hooking WeChat.
   - The second user, after hooking WeChat, chooses "Start a Temporary Encrypted Chat." This action transitions the first user to the Secret Chat Page.
3. **Key Exchange**: On the Secret Chat Page, the first user sends their key to initiate the secure chat, allowing the second user to enter the same encrypted session.

### Secret Chat Page

The Secret Chat Page facilitates secure messaging by leveraging each user's public key alongside their private key. This page automates the process of sending and receiving encrypted messages, ensuring secure communication between users.

# Develop Structure 

## Windows
Our app targets to make use of the open source WeChat hook to intercept the incoming WeChat messages, and send encrypted outgoing messages. During this process, RSA will be used as the main protocol to ensure the E2EE communication. Below is a summarization of the development chart. 
[TODO Windows Dev Chart Here]
### Underlying Technology
The underlying technology behind the WeChat injector is a sophisticated application of reverse engineering. The original author developed this tool from a publicly available GitHub repository. The process uses Cheat Engine to find the offset of the certain functions, such as send message and receive message functions, then they can accept the inputs from the users, and forward the received messages to the corresponding port. It monitors the WeChat process, specifically targeting the sending of messages and setting breakpoints. This allows for the identification of the corresponding assembly code responsible for these actions. Subsequently, APIs are established to leverage this assembly code for sending and receiving messages.

Additionally, the injector exploits a vulnerability in SQLite3. SQLite3 is used to maintain compatibility, with its API designed for downward compatibility. The approach involves using the `sqlite3_close` function as an anchor to locate other functions, based on the assumption that their offsets will remain consistent. This method allows for the systematic identification and utilization of various SQLite3 functions by referencing their fixed offsets.


- 添加 Process to use ICA to find vulnerabilities; SQL integration
- 
### General Structure
#### MERN Stack
In our application, the whole application is designed following the usual MERN (MongoDB, Express, React and Node) based structure. We applied this structure with an Electron based app. The similarity between MERN stack and Electron means it is possible for a single full stack developer to create, design and build the whole application without the need of knowing much about traditional Windows development tools. Both of them use Node.js as the backend and React.js as the frontend. Besides, it maintains key features as the desktop node, which means it could interact with the files to inject WeChat, create local database to save keypairs and make use of the WeChat hook, while keeping connection with the local APIs. 
#### NeDB
Similar to MERN stack, we choose NeDB as our local database. Compare to MongoDB, it is a light-weighted database without the requirement of individual database server and more common for a DB that only serves a single process. It keeps the NoSQL DB feature and uses the query commands that are similar to MongoDB. 

#### Inter-Process Communication
Although the Electron application is easy to develop, it does not force the application to use their best practices. It includes many unsafe features that might harm the user benefits. It allows direct calls between the frontend and backend process, which means that the developers might unintentionally create vulnerability between the frontend process and the main process. 
To avoid this security issue in our security-based application, we have utilized a architecture that isolates the backend Node.js environment from the frontend by utilizing secure IPC calls. The aim of this feature is to enhance the security by ensuring that communication between the frontend and backend is tightly controlled and monitored. 
IPC calls provide a secure channel for data exchanges, minimizing the attack surface by preventing direct access to the backend processes. The isolation helps us to protect sensitive backend operations, such as the key operations from potential threats from the frontend user interface. Besides, the IPC calls allows us to enforce strict access controls and validation mechanisms, which ensures that only our frontend could access our backend. 
Therefore, although this feature might increase our development complexity, we still utilized this feature to ensure the best practice. 

##### Others
During the development process, we 


install wechat/anti updaste
- NeDB
- 添加 Electron Builder How to include assets into installer
- 添加 Package Management NPM vs. YARN
- 添加 inject Tool的选择分析
- 添加 ReactContext
- Key Formatting -> JSON.stringlify() 为什么普通格式不行? 为什么一定要JSON
### Back End
- 添加Java/C以及其他的bat反制微信更新作为backend
### Front End

## Android
[TODO Android Dev Chart Here]
### Structure

## Design Concepts

# Process

## Solved Issues 
## Remain Unsolved Issues


# Issues
## Express Server Stall
During the setting up of express server, there is some probability that the express server cannot receive the messages, but all other functions remain in the hook do not have any issue. 


# Project Management
## Concepts Application
For the last several months, I have learned many essentail software development skills and applied them to our apps. The app design concepts  are usually a foundation of the whole software development process. 
### Coupling and Cohesion [TODO REF]
The high coupling refers to a situation where modules are highly dependent on each other. It means changing one module might require changes in several other modules as well. The low cohesion means that the functions within a module are not closely related and the module might be responsible for too many unrelated tasks or a module contains too many unrelated functions. The combination of these two issues might lead to code that is difficult to maintain and hard to extend.    
This issue is extremely difficult in Electron, because both frontend and backend code are in JavaScript. It means some functions can be done on the frontend, and they can be done on the backend as well. If the modules are not designed properly, the coupling will be very high. 
To avoid this issue, we follow the module design principle. During the development in Electron development. In the software, we separate the frontend logic and the backend logic. The basic principle is everything related to data will be strictly limited to only be processed on the backend, and everything regarding the interface will be strictly limited to the frontend. Therefore, even if the frontend and the backend changes, they will not influence each other, to afford a low coupling and high cohesion application. 

### Comments Reducing [TODO REF]
Regarding comments, it is really controversy. Many code examples encourage writing clear comments and docs. However, during the development process and the advice of my colleagues, I realized that the code readability is not really achieved by massive comments. It is based on clear and simple naming. When a software is designed in a good structure, the name of the function and the name of the variable could be meaningful and express their utilities. The comments will be redundant and unnecessary. For example, 
```
// The following variable indicates whether WeChat is hooked
let k = false;
```
the above block is not as clear as the below one. 
```
let isHooked = false;
```
Therefore, by applying this rule, we reduced many keys 
### Over Engineering [TODO REF]
Over engineering or early optimization is the mistake I made in this project. At the beginning of the project, we aim too much on designing the folder structure without the real requirement support. The general security standard is too high to ignore the real functionality design. Both resulted the development efficiency is low. 
However, the process finally does provide a relatively clear structure to allow me to extend the code structures. 

## Tools Utilization
## Live Debug
Developing an Electron app is similar to developing the web apps. Usually the web apps could apply the changes of the feature instantly and directly reflect instantly on the webpage. Electron framework inherits the benefits of web development while supporting the desktop app functions with multi-platform support. 
### Code Formatting
To maintain the clarity and maintenance of the code, it's essential to address common issues during coding. Therefore, in our project, I used ESLint and Prettier. ESLint helps in identifying and fixing code quality issues, while Prettier ensures consistent code formatting. By incorporating these tools into our development process, we not only make our code more readable to others but also to ourselves. As the saying goes, "Only God and I know what this code does... and sometimes even I'm not sure!" Proper formatting and linting help ensure that our code remains understandable, even as it evolves over time.

## 
- 添加 测试结果


# Potential Threats
## WXhelper Update
The project WXhelper is maintained by community members. Although the community members are keep contributing the new versions to follow up the WeChat versions, there are some minor changes are every update to make it not fully production reliable and hard to keep consistent update. For example, the API usually update very frequently and does not have a fixed pattern. For example, the type of the API calls route changes from the numeric numbers like `/api?type = 1` to meaning based routes like `/api/hookMessages`. 
It means every time they update their API, we might need to manually update it. That requires a continues distribution which this process can be interrupted by the third party.  

## Potential WeChat Anti-Measures
It is possible for WeChat to block E2EE communications on WeChat. It depends on whether this worth them to do that. 
### Entropy
For example, the message contains encrypted messages usually have a high entropy and looks like random bit stream. WeChat could monitor the messages and identify the high entropy messages and mark them as a strong encrypted messages and may block these high entropy messages as well if they want. 
### Length
Also, since the RSA data length is fixed after the encryption and does not follow the plaintext's length to change. WeChat could also identify if the users have sent the messages of the same length. 
### Deep Packet Inspection
Deep Package inspection could be used to check the transmission of the data packages. It could identify the encryption protocols 

# Unachieved Features
## Multi-language
The multi-language support is the essential requirement for an application that face both Chinese and English users. However, this proposal was considered but finally not achieved. 
The core thing to support multi-language is to use language files, such as JSON or YAML. This contains all the strings that are translatable in the application and will be put in the separate folder to use them. 
However, the development requires some changes on the UI. The UI design will be broke and need to be adjusted after the multi-language is deployed, which is a heavy work for an individual developer to implement. 
Also, during the development of the public apps, even the companies' app cannot achieve the multi-language support. 
## Multi-Platform
### Attempts
#### Unified Format
Initially, we used a conventional method to read file information and messages. This approach involved extracting the corresponding RSA key by checking for keywords in the file. However, we later switched to a unified JSON message format. JSON messages facilitate the transmission of the same information across multiple devices and languages more conveniently, avoiding compatibility issues when facing some special characters, such as the line change character, `\n`.

By adopting a unified JSON format, we were able to streamline communication between various devices, ensuring consistency in the data structure and reducing potential errors caused by language differences. This format also allowed for easier integration with other systems and tools, as JSON is a widely supported and flexible data format. The move towards JSON was a key step in ensuring that our encryption and messaging system could scale and adapt to different environments without sacrificing security or functionality.

#### Key Type and Import
We adopted the same RSA encryption method and settings to ensure that the generated RSA keys are identical. Additionally, I designed a feature that allows the RSA key generated on the mobile device to be imported into the computer. This enhances the synchronization of keys across multiple devices, ensuring that other contacts do not need to store different public keys for different platforms multiple times. The import works for the desktop version, but still doesn't work for the phone version.

This feature was particularly important for maintaining a seamless user experience and is an essential factor for evaluating my project. By allowing RSA keys to be shared and imported across devices, users could avoid the hassle of managing multiple keys for different platforms. The successful implementation on the desktop version demonstrated the feasibility and benefits of this approach. However, the challenges encountered in implementing this feature on the mobile version highlighted some of the limitations and complexities involved, such as differences in operating system capabilities, file handling, and security restrictions on mobile platforms. 

## Jest Testing
As we already discussed that testing is an essential part in the project, and Jest is a powerful testing tool for our project, but we finally only provide some simple examples and unfortunately cannot integrate it further to our project. The reasons are listed below. 
### Data Type
Within the project, the project content gives the Jest testing some challenges. To test with Jest, we need to simulate the real world conditions and give the expected return values to the functions. For example, if we want to test the decryption, we need to give the type of messages will receive on WeChat. However, since there are a various type of the message structures are used in the WeChat, and we cannot get the structures before we were trying in advance. It is impossible to apply a comprehensive and meaningful Jest testing. 
### Code Structure
Currently, within the code, there are a lot of async operations and the APIs of the WXhelper. To configure Jest with WeChat and WXhelper, it requires a lot of additional configurations and the customizations, causing an increase in the test writing and maintenance complexity. 

# Acknowledgement

感谢 导师 女朋友 
感谢 Syed，作为Koii Network的Chief of Engineering 给的建议
Pablo, Senior Developer 

